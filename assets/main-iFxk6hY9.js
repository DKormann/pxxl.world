import{W as M,a as k}from"./scripting-DaceTLTX.js";let E=window.location.hostname==="localhost"?"http://localhost:5000":"https://zmanifold.com";const w=document.querySelector("#app");function x(e){const t=document.createElement("button");return t.innerText=e,w.appendChild(t),t}const m=x("Show Code"),P=x("Reset Player"),_=document.createElement("span");w.appendChild(_);_.textContent=" ping: 0ms";const c=document.createElement("canvas"),C=Math.min(window.innerWidth,window.innerHeight)-m.clientHeight-10;c.width=C;c.height=C;w.appendChild(c);const f=c.getContext("2d"),i=new M("player",{position:{x:0,y:0},energy:0,id:"0"}),S=document.addEventListener.bind(document),g=[];let l=0;document.addEventListener=function(e,t){console.log("adding event listener",e,l),g.push({type:e,listener:t}),S(e,t)};function R(){g.forEach(e=>{const{type:t,listener:n}=e;console.log("removing event listener",t,l),document.removeEventListener(t,n)}),g.length=0}function L(e){R(),l++,console.log("loading script",l),console.log("script",e),new Function("action","state","player",e)(u,p,i)}m.onclick=()=>{window.location.href="/code"};S("keyup",e=>{e.key==="Escape"&&m.click()});const h=100,s=c.width/h;function j(e,t,n){f.fillStyle=n,f.fillRect(e*s,t*s,s,s)}let q=Array.from({length:h},()=>Array.from({length:h},()=>"red"));const p={player:i.value,world:q};i.subscribe(e=>{p.player=e});function A(){f.clearRect(0,0,c.width,c.height),p.world.forEach((e,t)=>e.forEach((n,y)=>{n!==null&&j(t,y,n)}))}let r=new WebSocket(E.replace("http","ws").replace("https","wss")+"/ws");console.log("connecting to",r.url);const a=new Map;let b=17;function d(){console.log("reloading player"),u({action:"put",x:0,y:0,player_id:"44"}).then(e=>{i.set(e),L(k.value)}).catch(e=>{console.error("error",e)})}P.onclick=d;i.value.id==="0"&&d();setInterval(()=>{i.value.energy<100&&(i.value.energy=Math.min(i.value.energy+100/20,100))},1e3/20);function u(e,t=i.value){e.player_id===void 0&&(e.player_id=t.id);const n=b++;if(e.action_id=n,typeof e.player_id!="string")throw new Error("player_id must be a string");return e.action_id===void 0&&(e.action_id=b++),new Promise((y,W)=>{const v=o=>{o.id==t.id&&(t.position=o.position,t.energy=o.energy)};a.set(n,{resolve:o=>{v(o),y(o)},reject:(o,z)=>{v(o),W(z)},timestamp:Date.now()});try{r.send(JSON.stringify(e))}catch(o){r.close(),console.error("error",o),r=new WebSocket(E.replace("http","ws").replace("https","wss")+"/ws"),a.clear()}e.action==="put"&&e.energy&&u({action:"info"},t)})}r.onmessage=e=>{let t;try{t=JSON.parse(e.data)}catch{console.error("error parsing",e.data);return}if(t.message_type==="world_update")p.world=t.content.blocks,A();else if(t.message_type==="action_response"){let n=a.get(t.action_id);n?t.error?n.reject(t.content,t.error):n.resolve(t.content):(console.error("action not found",t.action_id),console.log(t.error))}else if(t.message_type==="ack"){console.log("ack");const n=a.get(t.action_id);n&&(_.textContent=" ping: "+(Date.now()-n.timestamp)+"ms")}else console.error("unknown message type",t)};r.onopen=()=>{try{const e=i.value.position;u({action:"move",x:e.x,y:e.y,endx:e.x,endy:e.y}).catch(t=>{t==="player not found"&&d(),t!=="block already exists"&&console.error("error",t)})}catch(e){console.error("error",e),d()}L(k.value)};
