import{W as L,a as y}from"./scripting-DaceTLTX.js";let g=window.location.hostname==="localhost"?"http://localhost:5000":"https://zmanifold.com";const v=document.querySelector("#app");function _(e){const t=document.createElement("button");return t.innerText=e,v.appendChild(t),t}const m=_("Show Code"),W=_("Reset Player"),r=document.createElement("canvas");r.width=Math.min(window.innerWidth,window.innerHeight);r.height=Math.min(window.innerWidth,window.innerHeight);v.appendChild(r);const p=r.getContext("2d"),o=new L("player",{position:{x:0,y:0},energy:0,id:"0"}),b=document.addEventListener.bind(document),f=[];let s=0;document.addEventListener=function(e,t){console.log("adding event listener",e,s),f.push({type:e,listener:t}),b(e,t)};function z(){f.forEach(e=>{const{type:t,listener:n}=e;console.log("removing event listener",t,s),document.removeEventListener(t,n)}),f.length=0}function k(e){z(),s++,console.log("loading script",s),console.log("script",e),new Function("action","state",e)(u,d)}m.onclick=()=>{window.location.href="/code"};b("keyup",e=>{e.key==="Escape"&&m.click()});const h=100,l=r.width/h;function C(e,t,n){p.fillStyle=n,p.fillRect(e*l,t*l,l,l)}let M=Array.from({length:h},()=>Array.from({length:h},()=>"red"));const d={player:o.value,world:M};o.subscribe(e=>{d.player=e});function P(){p.clearRect(0,0,r.width,r.height),d.world.forEach((e,t)=>e.forEach((n,c)=>{n!==null&&(C(t,c,n),o.value.position.x===t&&o.value.position.y)}))}let i=new WebSocket(g.replace("http","ws").replace("https","wss")+"/ws");console.log("connecting to",i.url);const w=new Map;let E=17;function a(){console.log("reloading player"),u({action:"put",x:0,y:0,player_id:"44"}).then(e=>{o.set(e),k(y.value)}).catch(e=>{console.error("error",e)})}W.onclick=a;o.value.id==="0"&&a();function R(e){if(typeof e.player_id!="string")throw new Error("player_id must be a string");return e.action_id===void 0&&(e.action_id=E++),e}function u(e,t=o.value){e.player_id===void 0&&(e.player_id=t.id);const n=E++;return e.action_id=n,e=R(e),new Promise((c,x)=>{w.set(n,{resolve:c,reject:x});try{i.send(JSON.stringify(e))}catch(S){i.close(),console.error("error",S),i=new WebSocket(g.replace("http","ws").replace("https","wss")+"/ws"),w.clear()}e.action==="put"&&e.energy&&u({action:"info",x:0,y:0},t)})}setInterval(()=>{o.value.energy<100&&o.set({...o.value,energy:Math.min(o.value.energy+100/20,100)})},1e3/20);i.onmessage=e=>{let t;try{t=JSON.parse(e.data)}catch{console.error("error parsing",e.data);return}if(t.message_type==="world_update")d.world=t.content.blocks,P();else if(t.message_type==="action_response"){let n=w.get(t.action_id);if(!n){console.error(t.error),console.error("action not found",t.action_id);return}t.content.id===o.value.id&&o.set(t.content),t.error?(n.reject(t.error),console.log("action error",t.content)):n.resolve(t.content)}else console.error("unknown message type",t)};i.onopen=()=>{try{const e=o.value.position;u({action:"move",x:e.x,y:e.y,endx:e.x,endy:e.y}).catch(t=>{t==="player not found"&&a(),t!=="block already exists"&&console.error("error",t)})}catch(e){console.error("error",e),a()}k(y.value)};
